<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
  <!-- <script src="js/pixi.min.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<body>
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
  <script type="text/javascript">

    namespace = '/test';
    var socket = io(namespace);

    socket.on('connect', function() {
        console.log("Connected");   
    });

    socket.on('my_response', function(msg, cb) {
        console.log("MyResponse");   
    });

    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
    PIXI.utils.sayHello(type)

    window.PIXI = PIXI;
    window.PIXI[ "default" ] = PIXI;

    const app = new PIXI.Application({
        antialias: true,
        autoDensity: true,
        backgroundColor: 0x1099bb,
        resolution: devicePixelRatio,
    });
    document.body.appendChild(app.view);
    const loader = new PIXI.Loader(); // you can also create your own if you want

    // Chainable `add` to enqueue a resource
    loader.add('bunny', 'img/card.png')

    loader.load((loader, resources) => {
        for (let i = 0; i < 10; i++) {
            // Create our little bunny friend..
            console.log(resources);
            const bunny = new PIXI.Sprite(resources.bunny.texture);

            // Enable the bunny to be interactive... this will allow it to respond to
            // mouse and touch events
            bunny.interactive = true;

            // This button mode will mean the hand cursor appears when you roll over
            // the bunny with your mouse
            bunny.buttonMode = true;

            // Center the bunny's anchor point.
            bunny.anchor.set(0.5);

            console.log(bunny.width, bunny.scale, app.screen.width)
            // Make it a bit bigger, so it's easier to grab.
            bunny.scale.set(2);


            // setup events
            bunny
                // events for drag start
                .on('mousedown', onDragStart)
                .on('touchstart', onDragStart)
                // events for drag end
                .on('mouseup', onDragEnd)
                .on('mouseupoutside', onDragEnd)
                .on('touchend', onDragEnd)
                .on('touchendoutside', onDragEnd)
                // events for drag move
                .on('mousemove', onDragMove)
                .on('touchmove', onDragMove);
            // bunny.on('pointerdown', onDragStart);
            // bunny.on('pointerup', onDragEnd);
            // bunny.on('pointerupoutside', onDragEnd);

            // Move the sprite to its designated positio
            // console.log(bunny.parentElement.width, bunny.scale, app.screen.width)
            bunny.x = app.screen.width / 2 + (4.5-i)*(bunny.width+10);
            bunny.y = app.screen.height*4 / 5;
            bunny.ax = bunny.position.x;
            bunny.ay = bunny.position.y;
 
            // Add it into the scene
            app.stage.addChild(bunny);
        };
    });


    var graphics = new PIXI.Graphics();

    graphics.beginFill(0x1144CC);

    // set the line style to have a width of 5 and set the color to red
    graphics.lineStyle(5, 0x2277BB);

    // draw a rectangle
    // graphics.set(0.5);
    graphics.drawRect(-200, -100, 400, 200);
    graphics.x = app.screen.width / 2
    graphics.y = app.screen.height*1 / 5;


    app.stage.addChild(graphics);





    // Create a texture from an image path
    const imageTexture = PIXI.Texture.from('img/card.png');

    // Make the whole scene interactive
    app.stage.interactive = true;
    // Make sure stage captures all events when interactive
    app.stage.hitArea = app.renderer.screen;
    // Handle clicks on the canvas
    app.stage.on('click', onClick);
    // Populate scene graph with bunnies
   

    function onDragStart(event)
    {
        // this.ax = this.position.x;
        // this.ay = this.position.y;
        console.log(this.position, this.ax, this.ay)
        // store a reference to the data
        // the reason for this is because of multitouch
        // we want to track the movement of this particular touch
        this.data = event.data;
        this.alpha = 0.5;
        this.dragging = true;
    }

    function onDragEnd()
    {
        this.alpha = 1;

        this.dragging = false;

        console.log(this.position, this.ax, this.ay)
        if (this.position.y > graphics.position.y+graphics.height/2 ||
           !(this.position.x > graphics.position.x-graphics.width/2 && 
            this.position.x < graphics.position.x+graphics.width/2) )
        {
            this.position.y = this.ay;
            this.position.x = this.ax;
        }
        else{
            socket.emit('my_event', {data: 'In Rect'});
        }
        console.log(this.position, this.ax, this.ay)
        // set the interaction data to null
        this.data = null;
    }

    function onDragMove()
    {
        if (this.dragging)
        {
            var newPosition = this.data.getLocalPosition(this.parent);
            this.position.x = newPosition.x;
            this.position.y = newPosition.y;
        }
    }

    function onClick(e) {
        // if (selectedTarget) {
        //     selectedTarget.position.copyFrom(e.global);
        // }
    }


  </script>
</body>
</html>